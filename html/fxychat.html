<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0,user-scalable=no">
	<title>对话</title>
    <link rel="stylesheet" href="css/chat.css">
    <style>
        #box{width: 54px;height: 60px;display: none}
        .box1{width: 54px; height: 54px; position: absolute; left: 42%; top: 66px; /* background: #333; */}
        .box1 div:nth-child(1){
            width: 50px; height: 50px;
            border:2px solid #56D1A8;
            border-radius: 50%;
            border-top-color: transparent;
            border-bottom-color: transparent;
            -webkit-animation:rotate 1s ease-out infinite;
        }
        .box1 div:nth-child(2){
            width: 20px; height: 20px;
            border:2px solid #56D1A8;
            border-radius: 50%;
            border-left-color: transparent;
            border-right-color: transparent;
            position: absolute; left: 15px; top: 15px;
            -webkit-animation:rotate 0.5s ease-out infinite reverse;
        }
        @-webkit-keyframes rotate{
            0%{-webkit-transform: rotate(0deg) scale(1);}
            50%{-webkit-transform: rotate(180deg) scale(0.7);}
            100%{-webkit-transform: rotate(360deg) scale(1);}
        }
        #department{
            font-size: 12px;
            position: relative;
            top: -11px;
        }
        #big_img{background-color: black;width: 100%;position: absolute;height: 568px;top: 0;z-index: 9999;display: none}
        #bigImg{
            position: absolute;top: 0;bottom: 0;left: 0;right: 0;margin: auto;
            max-width: 100%;max-height: 100%;
        }
    </style>
</head>
<body>
  <header class="geoPosition whiteBg">
      <em  id="chat_back">
          <a class="backBtn" href="javascript:void(0)"></a>
      </em>
      <h3 class="nameDoc"><span id="chat_name"></span><br><span class="chat_expert"></span>&nbsp;&nbsp;<span id="department"></span></h3>
      <em class="perSign" id="perSign"></em>
  </header>
  <main>
      <div id="chatCon" class="chatCon clearfix">
          <div id="box">
              <div class="box1">
                  <div></div>
                  <div></div>
              </div>
          </div>
          <ul class="clearfix" id="chat_content" style="overflow: hidden">
              <!--<li class="rt">-->
              <!--<a href="#" class="facePic">-->
              <!--<img src="http://placehold.it/40x40" alt="">-->
              <!--</a>-->
              <!--<div class="commt"><span>同居</span>-->
              <!--<em class="sanjiao_right"></em>-->
              <!--</div>-->
              <!--</li>-->
              <!--<li class="lt">-->
              <!--<a href="#" class="facePic">-->
              <!--<img src="http://placehold.it/40x40" alt="">-->
              <!--</a>-->
              <!--<div class="commt"><span>同居</span>-->
              <!--<em class="sanjiao_left"></em>-->
              <!--</div>-->
              <!--</li>-->
              <!--<li class="lt">-->
              <!--<a href="#">-->
              <!--<img src="http://placehold.it/50x50" alt="">-->
              <!--</a>-->
              <!--<div class="commt">-->
              <!--你好，在吗？-->
              <!--</div>-->
              <!--</li>-->
              <!--<li class="rt">-->
              <!--<a href="#">-->
              <!--<img src="http://placehold.it/50x50" alt="">-->
              <!--</a>-->
              <!--<div class="commt">-->
              <!--在的呢~-->
              <!--</div>-->
              <!--</li>-->
              <!--<li class="rt">-->
              <!--<a href="#">-->
              <!--<img src="http://placehold.it/50x50" alt="">-->
              <!--</a>-->
              <!--<div class="commt">-->
              <!--在的呢~-->
              <!--</div>-->
              <!--</li>-->
              <!--<li class="rt">-->
              <!--<a href="#">-->
              <!--<img src="http://placehold.it/50x50" alt="">-->
              <!--</a>-->
              <!--<div class="commt">-->
              <!--在的呢~-->
              <!--</div>-->
              <!--</li>-->
              <!--<li class="rt">-->
              <!--<a href="#">-->
              <!--<img src="http://placehold.it/50x50" alt="">-->
              <!--</a>-->
              <!--<div class="commt">-->
              <!--在的呢~-->
              <!--</div>-->
              <!--</li>-->
          </ul>
      </div>
  </main>
 <footer>
     <div id="btnBox" class="importArea">
         <div class="chat_send" style="height: auto">
           <span class="uploadArea" id="send_photp">
              <input type="file" id="portrait" class="upPic" capture="camera">
              <img class="sendPhoto" src="../statics/img/sendPic.png">
          </span>
             <input type="text" id="msgIpt" class="inp">
             <input type="button" value="发送" class="send">
         </div>
         <!--  <img id="" src="img/record.jpg" alt="录音"> -->
     </div>
 </footer>
  <div id="big_img">
      <img src="" alt="" id="bigImg">
  </div>
  <script src="../statics/js/common/jquery-1.7.2.min.js"></script>
  <script src="http://cdn.ronghub.com/RongIMLib-2.2.4.min.js"></script>
  <script src="../statics/js/common/plupload.full.min.js"></script>
  <script src="../statics/js/common/qiniu.min.js"></script>
  <script type="text/javascript" src="../statics/js/common/jweixin-1.0.0.js"></script>
  <script type="text/javascript" src="../statics/js/common/RongEmoji-2.2.4.min.js"></script>
  <script src="../statics/js/common/basic.js"></script>
  <script type="text/javascript">
      $(function(){
         $('#big_img').attr('height',$(window).height()+'px');
          $('#big_img').attr('width',$(window).width()+'px');
          //判断滚动条是否滑到顶部
          var chat_content=document.getElementById('chat_content');
          var lastinfo_time=null;
          var drop=localStorage.getItem('drop');
          function getScrollTop()
          {
              var scrollTop=0;
              if(document.documentElement&&document.documentElement.scrollTop)
              {
                  scrollTop=document.documentElement.scrollTop;
              }
              else if(document.body)
              {
                  scrollTop=document.body.scrollTop;
              }
              return scrollTop;
          }
          var touchEvent={
              //向下滑动事件
              swipeDown:function(element,fn){
                  var isTouchMove, startTx, startTy;
                  element.addEventListener( 'touchstart', function( e ){
                      var touches = e.touches[0];
                      startTx = touches.clientX;
                      startTy = touches.clientY;
                      isTouchMove = false;
                  }, false );
                  element.addEventListener( 'touchmove', function( e ){
                      isTouchMove = true;
//                      e.preventDefault();
                  }, false );
                  element.addEventListener( 'touchend', function( e ){
                      if( !isTouchMove ){
                          return;
                      }
                      var touches = e.changedTouches[0],
                              endTx = touches.clientX,
                              endTy = touches.clientY,
                              distanceX = startTx - endTx
                      distanceY = startTy - endTy,
                              isSwipe = false;
                      if( Math.abs(distanceX) < Math.abs(distanceY) ){
                          if( distanceY < -20  ){
                              fn();
                              isSwipe = true;
                          }
                      }
                  }, false );
              }
          };
          var perSign=document.getElementById('perSign');
          perSign.onclick=function(){
              location.href='doctorPage.html'
          };
          //测试使用
//          var doctorId='20000000b154627c8fee4614aae4989795cfb1b0';
//          var userToken='b154627c8fee4614aae4989795cfb1b0220000000b154627c8fee4614aae4989795cfb1b0';
//          var userId='20000000b154627c8fee4614aae4989795cfb1b0';
//          //正式的
          var userToken=localStorage.getItem('userToken');
          var userId=localStorage.getItem('userId');
          var doctorId=localStorage.getItem('doctorId');
          var end_enquiry=localStorage.getItem('end_enquiry');
          var my_url='';
          var doctscor_url='';
          var hasMsginfo=true;
          var load_info=true;
          var first_info=true;
//          //初始化融云SDK
          RongIMLib.RongIMClient.init("pvxdm17jxm1mr");
          //初始化个人基本信息
          $.ajax({
              type:'get',
              url:YLZ.base+'com/pats/'+userId+'?token='+userToken,
              data:'',
              success:function(data){
                  my_url=data.info.image;
              }
          });
          //初始化医生信息
          $('.backBtn').on('click',function(){
              window.history.back(-1);
          });
          $.ajax({
          type:'get',
          url:window.YLZ.base+'com/docs/'+doctorId+'?token='+userToken,
          data:'',
           success:function(data){
                 $('#chat_name').html(data.doc.name);
                 $('.chat_expert').html(data.doc.hospital);
                 $('#department').html(data.doc.department);
                 doctor_url=data.doc.image;
              }
          });
          // RongIMLib.RongIMEmoji.init();
          //     //emoji
          //     var eArr=[];

          //     var emojis = new Array();

          //     emojis[0]=RongIMLib.RongIMEmoji.emojis[0];

          //     $.each(emojis,function(i,e){
          //       // alert(e.children[0].getAttribute("name"));
          //       var epic='<span class="RongIMExpression_rinning" name="'+e.children[0].getAttribute("name")+'"><b class="RC_Expression" style="background-position: '+(-22*(i))+'px 0px;"></b></span>';
          //       eArr[e.children[0].getAttribute("name")] = epic;
          //       $('.emoji_div').append(epic);
          //     });

          //     $('.emoji_div').on('click','.RongIMExpression_rinning',function(e){

          //       var oInp = $('.inp').val()+$(this).attr('name');
          //       $('.inp').val(oInp);
          //     // $('#content').append(tmpR);
          //     // $btnBox.find('.inp').val('');

          //     });

          var $btnBox = $('#btnBox'),
                  $sendBtn = $btnBox.find('.send'),
                  $upPic = $btnBox.find('.upPic');
          //文本
          $sendBtn.on('click',function(){
              var inp = $btnBox.find('.inp').val();
              if(inp==''){
                  return;
              }
              var sendContent = inp.replace(/\[[\u4e00-\u9fa5]+\]/,function(emojiName){
                  return eArr[emojiName] ;
              });
              var tmpR='<li class="rt">'+
                      '<a href="#" class="facePic">'+
                      '<img src="'+my_url+'" alt="">'+
                      '</a>'+
                      '<div class="commt">'+sendContent+'</div>'+
                      '</li>';
              $('#chatCon ul').append(tmpR);
              $btnBox.find('.inp').val('');

              var targetId = doctorId; // 目标 Id
              var msg = new RongIMLib.TextMessage({'content':inp,'extra':'','user':targetId});
              sendMsg(msg,targetId);
          });

          // //融云聊天token获取
          var chatTokenUrl = window.YLZ.base+'com/token/rongcloud?token='+userToken;
          var token='';
          $.ajax({
              type:"get",
              url:chatTokenUrl,
              data:{

              },
              success:function(data){
                  token = data.token;
//                  alert(token);
                  // console.log(typeof token);
                  //console.log(token);
                  // debugger;
                  //链接融云服务器
                  RongIMClient.connect(token,{
                      onSuccess: function(userId) {
                          function getInfo(){
                              var conversationType = RongIMLib.ConversationType.PRIVATE; //私聊,其他会话选择相应的消息类型即可。
                              var targetId = doctorId; // 想获取自己和谁的历史消息，targetId 赋值为对方的 Id。
                              var timestrap =null; // 默认传 null，若从头开始获取历史消息，请赋值为 0 ,timestrap = 0;
                              var count = 20; // 每次获取的历史消息条数，范围 0-20 条，可以多次获取。
                              RongIMLib.RongIMClient.getInstance().getHistoryMessages(conversationType, targetId,timestrap, count, {
                                  onSuccess: function(list, hasMsg) {
                                      //console.log(list);
                                      //console.log(hasMsg);
                                      hasMsginfo=hasMsg;
                                      if(!first_info){
                                          list.reverse();
                                      }
                                      // list => Message 数组。
                                      // hasMsg => 是否还有历史消息可以获取。
                                      //获取聊天记录渲染到页面中
                                      $('#box').css('display','none');
                                      //判断消息类型
                                      for(var j=0;j<list.length;j++){
                                          if(list[j].objectName=='91:ask'){
                                              continue;
                                          }
                                          if(list[j].objectName=='RC:TxtMsg'){
                                              if(list[j].senderUserId==userId){
                                                  var tmpR='<li class="rt">'+
                                                          '<a href="#" class="facePic">'+
                                                          '<img src="'+my_url+'" alt="">'+
                                                          '</a>'+
                                                          '<div class="commt">'+list[j].content.content+'</div>'+
                                                          '</li>';
                                                  if(first_info){
                                                      $('#chatCon ul').append(tmpR);
                                                  }else{
                                                      $('#chatCon ul').prepend(tmpR);
                                                  }
                                              }else{
                                                  var tmpL='<li class="lt">'+
                                                          '<a href="#" class="facePic">'+
                                                          '<img src="'+doctor_url+'" alt="">'+
                                                          '</a>'+
                                                          '<div class="commt">'+ list[j].content.content +'</div>'+
                                                          '</li>';
                                                  if(first_info){
                                                      $('#chatCon ul').append(tmpL);
                                                  }else{
                                                      $('#chatCon ul').prepend(tmpL);
                                                  }
                                              }
                                          }
                                          if(list[j].objectName=="RC:ImgMsg"){
                                              if(list[j].senderUserId==userId){
                                                  var tmpR='<li class="rt">'+
                                                          '<a href="#" class="facePic">'+
                                                          '<img src="'+my_url+'" alt="">'+
                                                          '</a>'+
                                                          '<div class="commt imgBg"><img class="imgSmall" src="'+list[j].content.imageUri+'" alt=""></div>'+
                                                          '</li>';
                                                  if(first_info){
                                                      $('#chatCon ul').append(tmpR);
                                                  }else{
                                                      $('#chatCon ul').prepend(tmpR);
                                                  }
                                                 DrawImage();
                                              }else{
                                                  var tmpL='<li class="lt">'+
                                                          '<a href="#" class="facePic">'+
                                                          '<img src="'+doctor_url+'" alt="">'+
                                                          '</a>'+
                                                          '<div class="commt imgBg"><img class="imgSmall" src="'+list[j].content.imageUri+'" alt=""></div>'+
                                                          '</li>';
                                                  if(first_info){
                                                      $('#chatCon ul').append(tmpL);
                                                  }else{
                                                      $('#chatCon ul').prepend(tmpL);
                                                  }
                                                  DrawImage();
                                              }
                                          }
                                      }
                                      if(end_enquiry=='true'){
                                          end_enquiry='false';
                                          $('#chatCon ul').append('<h2 id="enqu_end" style="text-align: center; font-size: 13px; margin:4rem 30%;float: left;width: 40%">您的本次问诊已结束</h2>')
                                      }
                                      if(first_info){
//                                          $('document').scrollTop($('#chat_content').height()-$(window).height());
                                          $('#chatCon').scrollTop($('#chat_content').height()-$(window).height()+200);
                                          first_info=false;
                                      }
                                      load_info=true;
                                  },
                                  onError: function(error) {
                                      //console.log("GetHistoryMessages,errorcode:" + error);
                                  }
                              });
//                              clear_info(doctorId)
                              //图片点击放大
                              $('#chat_content').on('click','li .imgSmall',function(){
                                  var big=$(this);
                                  $('#big_img').css('display','block');
                                  $('#bigImg').attr('src',big.attr('src'))
                              });
                              $('#big_img').on('click',function(){
                                  $(this).css('display','none')
                              })
                          }
                          if(drop=='get'){
                              getInfo();
                          }
                          //等加载到顶部的时候，要显示加载更多
                          function display(){
                              $('#box').css('display','none');
                          }
                          touchEvent.swipeDown(chat_content,function(){
                              if(hasMsginfo){
                                  if(load_info){
                                      if($('#chatCon').scrollTop()==0){
                                          load_info=false;
                                          $('#box').css('display','block');
                                          getInfo();
                                      }
                                  }
                                  //console.log($('#chatCon').scrollTop())
                              }else{
                                  $('#box').css('display','block');
                                  setTimeout(display,600)
                              }
                          });

                          //发送图片
                          //上传token获取
                          var qnUpTokenUrl = window.YLZ.base+'com/token/qiniu/uptoken?bucket=yyy-pat&token='+userToken;
                          var upPicToken;
                          $.ajax({
                              type:'get',
                              url:qnUpTokenUrl,
                              data:{

                              },
                              success:function(data){
                                  upPicToken = data.token;
                                  //console.log(upPicToken)
//                  var yuming = data.domain;
                                  var uploader = Qiniu.uploader({
                                      runtimes: 'html5,flash,html4',
                                      browse_button: 'portrait',
                                      // uptoken : 'JGwgjvdzdhq-SMx-P6vjeoRx1c5HmVJiUv8Cn2G0:pGjRnSnr8K_nShbPzOvqfyN5tyo=:eyJzY29wZSI6InN0b3J0ZSIsImRlYWRsaW5lIjoxNDc4NDU0OTQxfQ==',
                                      uptoken:upPicToken,
                                      unique_names: true,
                                      domain: 'yyy-pat',
                                      get_new_uptoken: false,//设置上传文件的时候是否每次都重新获取新的uptoken
                                      container: 'btnBox',
                                      max_file_size: '100mb',
                                      flash_swf_url: 'js/plupload/Moxie.swf',
                                      max_retries: 3,
                                      dragdrop: true,
                                      drop_element: 'btnBox',
                                      chunk_size: '0mb',
                                      auto_start: true,
                                      resize:{
                                        crop:true,
                                        quality:60,
                                        preserve_headers:false
                                      }, 
                                      init: {
                                          'FilesAdded': function(up, files) {
                                              plupload.each(files, function(file) {
                                                  // 文件添加进队列后，处理相关的事情
                                              });
                                          },
                                          'BeforeUpload': function(up, file) {
                                              // 每个文件上传前，处理相关的事情
                                          },
                                          'UploadProgress': function(up, file) {
                                              // 每个文件上传时，处理相关的事情

                                          },
                                          'FileUploaded': function(up, file, info) {
                                              // 每个文件上传成功后，处理相关的事情
                                              // 其中info是文件上传成功后，服务端返回的json，形式如：
                                              // {
                                              //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                                              //    "key": "gogopher.jpg"
                                              //  }
                                              var domain = 'http://ofp7knoi8.bkt.clouddn.com/';
                                              //console.log('info='+info);
                                              //console.log(typeof info)
                                              var res = JSON.parse(info);
                                              var imageUri = domain + res.key;
                                              var oFile= file.getNative();
                                              var oReader = new FileReader();
                                              oReader.onloadend = function(e) {
                                                  var base64Str = e.target.result;
                                                  var andbase = base64Str.split(',')[1];
                                                  var targetId = doctorId; // 目标 Id
                                                  var tmpR='<li class="rt">'+
                                                          '<a href="#" class="facePic">'+
                                                          '<img src="'+my_url+'" alt="">'+
                                                          '</a>'+
                                                          '<div class="commt imgBg"><img class="imgSmall" src="'+imageUri+'" alt=""></div>'+
                                                          '</li>';
                                                  $('#chatCon ul').append(tmpR);
                                                  DrawImage();
                                                  // DrawImage($('.imgSmall').last().get(0));
                                                  var msg = new RongIMLib.ImageMessage({content:andbase,imageUri:imageUri});
                                                  var conversationtype = RongIMLib.ConversationType.PRIVATE; // 私聊,其他会话选择相应的消息类型即可。
                                                  RongIMClient.getInstance().sendMessage(conversationtype, targetId, msg, {
                                                              onSuccess: function (message) {
                                                                  //message 为发送的消息对象并且包含服务器返回的消息唯一Id和发送消息时间戳
                                                                  //console.log("Send successfully");
                                                              },
                                                              onError: function (errorCode,message) {
                                                                  var info = '';
                                                                  switch (errorCode) {
                                                                      case RongIMLib.ErrorCode.TIMEOUT:
                                                                          info = '超时';
                                                                          break;
                                                                      case RongIMLib.ErrorCode.UNKNOWN_ERROR:
                                                                          info = '未知错误';
                                                                          break;
                                                                      case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
                                                                          info = '在黑名单中，无法向对方发送消息';
                                                                          break;
                                                                      case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
                                                                          info = '不在讨论组中';
                                                                          break;
                                                                      case RongIMLib.ErrorCode.NOT_IN_GROUP:
                                                                          info = '不在群组中';
                                                                          break;
                                                                      case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
                                                                          info = '不在聊天室中';
                                                                          break;
                                                                      default :
                                                                          break;
                                                                  }
                                                                 // console.log('发送失败:' + info);
                                                              }
                                                          }
                                                  );
                                              };
                                              oReader.readAsDataURL(oFile);

                                          },
                                          'Error': function(up, err, errTip) {
                                              //上传出错时，处理相关的事情
                                          },
                                          'UploadComplete': function() {
                                              //队列文件处理完毕后，处理相关的事情
                                          },
                                          'Key': function(up, file) {
                                              // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                                              // 该配置必须要在unique_names: false，save_key: false时才生效

                                              var key = "";
                                              // do something with key here
                                              return key
                                          }
                                      }
                                  });
                              }
                          });
                      },
                      onTokenIncorrect: function() {
//                  console.log('token无效');
                      },
                      onError:function(errorCode){
                          var info = '';
                          switch (errorCode) {
                              case RongIMLib.ErrorCode.TIMEOUT:
                                  info = '超时';
                                  break;
                              case RongIMLib.ErrorCode.UNKNOWN_ERROR:
                                  info = '未知错误';
                                  break;
                              case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:
                                  info = '不可接受的协议版本';
                                  break;
                              case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:
                                  info = 'appkey不正确';
                                  break;
                              case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:
                                  info = '服务器不可用';
                                  break;
                          }
                          //console.log(errorCode);
                      }
                  });
              }
          });



          // var emojis = RongIMLib.RongIMEmoji.emojis;
          // for(var i=0;i<128;i++){
          //     $('.emoji_div').append(emojis[i].innerHTML);
          // }
          //console.log(RongIMLib.RongIMEmoji.emojis)
// 设置连接监听状态 （ status 标识当前连接状态 ）
          // 连接状态监听器
          RongIMClient.setConnectionStatusListener({
              onChanged: function (status) {
                  switch (status) {
                      case RongIMLib.ConnectionStatus.CONNECTED:
                          //
                          // console.log('链接成功');
                          break;
                      case RongIMLib.ConnectionStatus.CONNECTING:
                          //console.log('正在链接');
                          break;
                      case RongIMLib.ConnectionStatus.DISCONNECTED:
                          //console.log('断开连接');
                          break;
                      case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:
                          //console.log('其他设备登录');
                          break;
                      case RongIMLib.ConnectionStatus.DOMAIN_INCORRECT:
                          //console.log('域名不正确');
                          break;
                      case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:
                          //console.log('网络不可用');
                          break;
                  }
              }});
          //清除未读消息
          function clear_info(target){
              var conversationType = RongIMLib.ConversationType.PRIVATE;
              var targetId = target;
              RongIMClient.getInstance().clearUnreadCount(conversationType,targetId,{
                  onSuccess:function(){
                      console.log('清除未读消息数成功')
                  },
                  onError:function(error){
                      // error => 清除未读消息数错误码。
                      console.log(error)
                  }
              });
          }
          // 消息监听器
          RongIMClient.setOnReceiveMessageListener({
              // 接收到的消息
              onReceived: function (message) {
                  // 判断消息类型
                  switch(message.messageType){
                      case RongIMClient.MessageType.TextMessage:
                          // message.content.content => 消息内容
//                          console.log(message.content.user+" : "+message.content.content);
                          // var str = RongIMLib.RongIMEmoji.symbolToHTML("[露齿而笑]测试 Emoji");
                          var tmpL='<li class="lt">'+
                                  '<a href="#" class="facePic">'+
                                  '<img src="'+doctor_url+'" alt="">'+
                                  '</a>'+
                                  '<div class="commt">'+ message.content.content +'</div>'+
                                  '</li>';
                          $('#chatCon ul').append(tmpL);
                              clear_info(doctorId)
                          break;
                      case RongIMClient.MessageType.VoiceMessage:
                          // 对声音进行预加载
                          // message.content.content 格式为 AMR 格式的 base64 码
                          break;
                      case RongIMClient.MessageType.ImageMessage:
                          // message.content.content => 图片缩略图 base64。
                          // message.content.imageUri => 原图 URL。
                             console.log(message.content.content);
                          var tmpL='<li class="lt">'+
                                  '<a href="#" class="facePic">'+
                                  '<img src="'+doctor_url+'" alt="">'+
                                  '</a>'+
                                  '<div class="commt imgBg"><img class="imgSmall" src="'+message.content.imageUri+'" alt=""></div>'+
                                  '</li>';
                          $('#chatCon ul').append(tmpL);
                          DrawImage();
                          clear_info(doctorId);
                          // DrawImage($('.imgSmall').last().get(0));
                          break;
                      case RongIMClient.MessageType.DiscussionNotificationMessage:
                          // message.content.extension => 讨论组中的人员。
                          break;
                      case RongIMClient.MessageType.LocationMessage:
                          // message.content.latiude => 纬度。
                          // message.content.longitude => 经度。
                          // message.content.content => 位置图片 base64。
                          break;
                      case RongIMClient.MessageType.RichContentMessage:
                          // message.content.content => 文本消息内容。
                          // message.content.imageUri => 图片 base64。
                          // message.content.url => 原图 URL。
                          break;
                      case RongIMClient.MessageType.InformationNotificationMessage:
                          // do something...
                          break;
                      case RongIMClient.MessageType.ContactNotificationMessage:
                          // do something...
                          break;
                      case RongIMClient.MessageType.ProfileNotificationMessage:
                          // do something...
                          break;
                      case RongIMClient.MessageType.CommandNotificationMessage:
                          // do something...
                          break;
                      case RongIMClient.MessageType.CommandMessage:
                          // do something...
                          break;
                      case RongIMClient.MessageType.UnknownMessage:
                          // do something...
                          break;
                      default:
                      // do something...
                  }
              }
          });
          function sendMsg(msg,targetId){
              var conversationtype = RongIMLib.ConversationType.PRIVATE; // 私聊,其他会话选择相应的消息类型即可。
              RongIMClient.getInstance().sendMessage(conversationtype, targetId, msg, {
                          onSuccess: function (message) {
                              //message 为发送的消息对象并且包含服务器返回的消息唯一Id和发送消息时间戳
                              //g("Send successfully");
                          },
                          onError: function (errorCode,message) {
                              var info = '';
                              switch (errorCode) {
                                  case RongIMLib.ErrorCode.TIMEOUT:
                                      info = '超时';
                                      break;
                                  case RongIMLib.ErrorCode.UNKNOWN_ERROR:
                                      info = '未知错误';
                                      break;
                                  case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
                                      info = '在黑名单中，无法向对方发送消息';
                                      break;
                                  case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
                                      info = '不在讨论组中';
                                      break;
                                  case RongIMLib.ErrorCode.NOT_IN_GROUP:
                                      info = '不在群组中';
                                      break;
                                  case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
                                      info = '不在聊天室中';
                                      break;
                                  default :
                                      break;
                              }
                              //console.log('发送失败:' + info);
                          }
                      }
              );
              //getConversationList示例

//              RongIMClient.getInstance().getConversationList({
//                  onSuccess: function(list) {
//                      console.log(list);
//                  },
//                  onError: function(error) {
//                      // do something...
//                  }
//              },null);
//              //getHistoryMessages
//              RongIMClient.getInstance().getHistoryMessages(RongIMLib.ConversationType.PRIVATE, 'targetId', null, 20, {
//                  onSuccess: function(list, hasMsg) {
//                      // hasMsg为boolean值，如果为true则表示还有剩余历史消息可拉取，为false的话表示没有剩余历史消息可供拉取。
//                      // list 为拉取到的历史消息列表
//                  },
//                  onError: function(error) {
//                      // APP未开启消息漫游或处理异常
//                      // throw new ERROR ......
//                  }
//              });
          }
          function DrawImage(){
              var image=$('.imgSmall').last();
              if(image.width()>0 && image.height()>0){
                  if(image.width()/image.height()>= 120/90){
                      if(image.width()>120){
                          image.attr('width','120px');
                          image.attr('height',(image.height()*120)/image.width()+'px');
                      }else{
                          image.attr('width',image.width()+'px');
                          image.attr('height',image.height()+'px');
                      }
                      image.attr('alt',image.width()+'x'+image.height())
                  }
                  else{
                      if(image.height()>200){
                          image.attr('height',200+'px');
                          image.attr('width',(image.width()*120)/image.height()+'px');
//                          ImgD.width=(image.width*90)/image.height;
                      }else{
//                          ImgD.width=image.width;
//                          ImgD.height=image.height;
                          image.attr('width',image.width()+'px');
                          image.attr('height',image.height()+'px');
                      }
                      image.attr('alt',image.width()+'x'+image.height())
                  }
              }
          }
      });
  </script>
</body>
</html>